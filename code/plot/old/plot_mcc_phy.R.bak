library(ggplot2)
library(ggtree)
library(ape)
library(phyloch)

add_island_times = function(p) {

    t = "dashed"
    p = p + geom_vline(xintercept=15-6.00, color="#7570b3", linetype=t)
    p = p + geom_vline(xintercept=15-6.30, color="#7570b3", linetype=t)
    p = p + geom_vline(xintercept=15-3.93, color="#e7298a", linetype=t)
    p = p + geom_vline(xintercept=15-4.34, color="#e7298a", linetype=t)
    p = p + geom_vline(xintercept=15-2.1, color="#66a61e", linetype=t)
    p = p + geom_vline(xintercept=15-3.0, color="#66a61e", linetype=t)
    p = p + geom_vline(xintercept=15-1.1, color="#e6ab02", linetype=t)
    p = p + geom_vline(xintercept=15-1.3, color="#e6ab02", linetype=t)

    return(p)

}


# read tree
fp = "/Users/mlandis/projects/vib_div/"
fn = "output/tinus/out.1.viburnum.t163.f5"
phy_fn = paste(fp, fn, ".mcc.tre", sep="")
out_fn = paste(fp, fn, ".mcc.pdf", sep="")
phy = read.beast(phy_fn)
phy2 = read.nexus(phy_fn)

bt = c( rep(0,length(phy2$tip.label)), branching.times(phy2) )
heights = bt[ as.numeric(phy@stats$node) ]

# subtract the MCC age from the HPD range to get lengths
phy@stats$height = heights
heights_hpd = phy@stats$age_0.95_HPD
print(heights_hpd)
for (i in 1:length(heights_hpd)) {
    hpd = as.numeric(heights_hpd[[i]])
    h = heights[i]
    if (!is.na(hpd)) {
        h_tmp = c( 2*h-hpd[2], 2*h-hpd[1] ) 
        heights_hpd[[i]] = h_tmp
    }
    #dh = mean(hpd)-h
    #h_tmp = hpd+dh
    #heights_hpd[[i]] = hpd + 1*dh
    #print(h)
}
phy@stats$height_0.95_HPD = heights_hpd
phy@fields = c(phy@fields, "height", "height_0.95_HPD")

pdf(out_fn, width=7, height=7)

max_time = 90
pp = ggtree(phy,  ndigits=2 )
xx = pp$data$x
pp$data$x = pp$data$x + (max_time - max(pp$data$x))
yy = pp$data$x
pp$data$posterior_class = NA
pp$data$posterior_class[ which(pp$data$posterior > 0.95) ] = ">0.95"
pp$data$posterior_class[ which(pp$data$posterior<=0.95&pp$data$posterior>0.75) ] = ">0.75"
pp$data$posterior_class[ which(pp$data$posterior<=0.75&pp$data$posterior>0.5) ] = ">0.50"
pp$data$posterior_class[ which(pp$data$posterior<=0.5) ] = "<0.50"
pp$data$posterior_class = factor(pp$data$posterior_class, levels=c(">0.95",">0.75", ">0.50", "<0.50"))
pp$data$label = sapply(pp$data$label, function(x) { gsub("_"," ",x) })
pp$data$label = sapply(pp$data$label, function(x) { gsub("subsp. ","",x) })
#pp = pp + geom_vline(xintercept = c(0,-5,-10,-15, -14.1533, 15-4.08946), lty=2, color="gray")
#pp = pp + geom_vline(xintercept = c(15-14.1533, 15-4.08946), lty=2, color="gray")
#pp = pp + geom_vline(xintercept = c(15-14.1533, 15-4.08946), lty=2, color="gray")
#pp = add_island_times(pp)
pp = pp + geom_range(range='height_0.95_HPD', color='dodgerblue', alpha=.6, size=1)
#ppz = pp
#zz= geom_range.mjl(range='height_0.95_HPD', color='dodgerblue', alpha=.6, size=1)
pp = pp + geom_tiplab(size=1.8, offset=0.25)
#pp = pp + geom_point2(aes(subset=(node>38), colour=posterior_class), size=5, shape=23)
pp = pp + geom_nodepoint( size=2, color="black")
pp = pp + geom_nodepoint(aes(color=posterior_class), size=1.5)


pp = pp + scale_color_manual(values=c("#000000","#666666","#BBBBBB","#EEEEEE"), name="Posterior")
#pp = pp + scale_x_continuous(breaks = c(-15, -10, -5, 0), labels = c(15, 10, 5, 0))
pp = pp + scale_x_continuous(breaks = seq(0,max_time,10) )


pp = pp + theme_tree2()

pp = pp + coord_cartesian(xlim = c(0,19), expand=TRUE)
pp = pp + labs(x="Age (Myrs)")
#pp = pp + guides(colour = guide_legend(order = 1)) #, linetype = guide_legend(order = 2))
#pp = pp + revts(pp)
#pp = pp + theme(legend.position = c(.95, .95),
pp = pp + theme(legend.position=c(.05, .50), axis.line = element_line(colour = "black"))

#pp = add_island_times(pp)

print(pp)
dev.off()
